name: Deploy to Render

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allow manual trigger

jobs:
  deploy-myapp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Trigger Render Deploy (MYAPP)
        run: |
          echo "🚀 Deploying MYAPP..."
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.render.com/v1/services/${{ secrets.RENDER_MYAPP_ID }}/deploys)

          echo "Raw trigger response: $RESPONSE"

          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -z "$DEPLOY_ID" ]; then
            echo "❌ Failed to get deploy ID for MYAPP"
            exit 1
          fi

          echo "Got deploy ID for MYAPP: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV

  deploy-user:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Trigger Render Deploy (USER)
        run: |
          echo "🚀 Deploying USER..."
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.render.com/v1/services/${{ secrets.RENDER_USER_ID }}/deploys)

          echo "Raw trigger response: $RESPONSE"

          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -z "$DEPLOY_ID" ]; then
            echo "❌ Failed to get deploy ID for USER"
            exit 1
          fi

          echo "Got deploy ID for USER: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV

  deploy-admin-spring:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Trigger Render Deploy (ADMIN-Spring)
        run: |
          echo "🚀 Deploying ADMIN-Spring..."
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.render.com/v1/services/${{ secrets.RENDER_ADMIN_SPRING_ID }}/deploys)

          echo "Raw trigger response: $RESPONSE"

          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -z "$DEPLOY_ID" ]; then
            echo "❌ Failed to get deploy ID for ADMIN-Spring"
            exit 1
          fi

          echo "Got deploy ID for ADMIN-Spring: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV
